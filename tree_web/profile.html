<!DOCTYPE HTML>
<html>
	<head>
		<title>My Profile - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" class="wrapper">
					<!-- Auth Buttons -->
					<div id="auth-container">
						<!-- Will be populated by JavaScript -->
					</div>

					<!-- Logo -->
						<div id="logo">
							<h1><a href="index.html">TreeMapper</a></h1>
							<p>Discover and track trees in your community</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li><a href="treeMap.html">Tree Map</a></li>
								<li><a href="pollution.html">Pollution Map</a></li>
								<li>
									<a href="treeDatabase.html">Tree Database</a>
									<ul>
										<li><a href="treeDatabase.html#tree-types">Tree Type Database</a></li>
										<li><a href="treeDatabase.html#tree-database">Tree Database</a></li>
										<li><a href="treeDatabase.html#upload-tree">Upload Tree</a></li>
									</ul>
								</li>
								<li><a href="community.html">Community</a></li>
								<li class="admin-only"><a href="adminDashboard.html">Admin Dashboard</a></li>
							</ul>
						</nav>
				</section>

			<!-- Main -->
				<section id="main" class="wrapper style2">
					<div class="title">My Profile</div>
					<div class="container">
						<div class="profile-content">
							<div class="row">
								<div class="col-8 col-12-medium">
									<section class="profile-info">
										<h2>Profile Information</h2>
										<div class="info-grid">
											<div class="info-item">
												<label>Username</label>
												<p id="profile-username"></p>
											</div>
											<div class="info-item">
												<label>Email</label>
												<p id="profile-email"></p>
											</div>
											<div class="info-item">
												<label>Role</label>
												<p id="profile-role"></p>
											</div>
											<div class="info-item">
												<label>Member Since</label>
												<p id="profile-created"></p>
											</div>
										</div>
									</section>

									<!-- Update Username Form -->
									<section class="update-section">
										<h3>Change Username</h3>
										<form id="update-username-form" class="form">
											<div class="row gtr-50">
												<div class="col-12">
													<input type="text" name="new_username" placeholder="New Username" required />
												</div>
												<div class="col-12">
													<input type="password" name="current_password" placeholder="Current Password" required />
												</div>
												<div class="col-12">
													<ul class="actions">
														<li><input type="submit" class="button style1" value="Update Username" /></li>
													</ul>
												</div>
											</div>
										</form>
									</section>

									<!-- Change Password Form -->
									<section class="update-section">
										<h3>Change Password</h3>
										<form id="change-password-form" class="form">
											<div class="row gtr-50">
												<div class="col-12">
													<input type="password" name="current_password" placeholder="Current Password" required />
												</div>
												<div class="col-12">
													<input type="password" name="new_password" placeholder="New Password" required />
												</div>
												<div class="col-12">
													<input type="password" name="confirm_new_password" placeholder="Confirm New Password" required />
												</div>
												<div class="col-12">
													<ul class="actions">
														<li><input type="submit" class="button style1" value="Change Password" /></li>
													</ul>
												</div>
											</div>
										</form>
									</section>
								</div>
								<div class="col-4 col-12-medium">
									<section class="profile-actions">
										<ul class="actions special">
											<li><a href="#" id="logout-button" class="button style3">Logout</a></li>
										</ul>
									</section>
								</div>
							</div>
						</div>
					</div>
				</section>

			<!-- Footer -->
				<section id="footer" class="wrapper">
					<div class="container">
						<div id="copyright">
							<ul>
								<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
							</ul>
						</div>
					</div>
				</section>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/auth.js"></script>
			<script>
				document.addEventListener('DOMContentLoaded', function() {
					checkAuth();
					loadProfileData();
					setupFormHandlers();
				});

				function loadProfileData() {
					fetch('api/user.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_profile' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							document.getElementById('profile-username').textContent = data.user.username;
							document.getElementById('profile-email').textContent = data.user.email;
							document.getElementById('profile-role').textContent = data.user.role;
							document.getElementById('profile-created').textContent = new Date(data.user.created_at).toLocaleDateString();
							
							// Add status display if needed
							const statusElement = document.getElementById('profile-status');
							if (statusElement && data.user.status) {
								statusElement.textContent = data.user.status;
							}
						} else {
							console.error('Failed to load profile:', data.message);
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}

				function setupFormHandlers() {
					// Handle Username Update
					document.getElementById('update-username-form').addEventListener('submit', function(e) {
						e.preventDefault();
						const formData = new FormData(this);
						fetch('api/user.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								action: 'update_username',
								new_username: formData.get('new_username'),
								current_password: formData.get('current_password')
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								showMessage('success', 'Username updated successfully');
								loadProfileData(); // Reload profile data
								this.reset();
							} else {
								showMessage('error', data.message);
							}
						})
						.catch(error => {
							showMessage('error', 'An error occurred. Please try again.');
							console.error('Error:', error);
						});
					});

					// Handle Password Change
					document.getElementById('change-password-form').addEventListener('submit', function(e) {
						e.preventDefault();
						const formData = new FormData(this);
						
						// Validate password match
						if (formData.get('new_password') !== formData.get('confirm_new_password')) {
							showMessage('error', 'New passwords do not match');
							return;
						}

						fetch('api/user.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({
								action: 'change_password',
								current_password: formData.get('current_password'),
								new_password: formData.get('new_password')
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								showMessage('success', 'Password changed successfully');
								this.reset();
							} else {
								showMessage('error', data.message);
							}
						})
						.catch(error => {
							showMessage('error', 'An error occurred. Please try again.');
							console.error('Error:', error);
						});
					});
				}

				// Helper function to show messages
				function showMessage(type, message) {
					const messageDiv = document.createElement('div');
					messageDiv.className = `message ${type}`;
					messageDiv.textContent = message;
					
					// Remove any existing messages
					const existingMessages = document.querySelectorAll('.message');
					existingMessages.forEach(msg => msg.remove());
					
					// Add the new message at the top of the container
					const container = document.querySelector('.container');
					container.insertBefore(messageDiv, container.firstChild);
					
					// Remove message after 3 seconds
					setTimeout(() => {
						messageDiv.remove();
					}, 3000);
				}
			</script>
	</body>
</html> 