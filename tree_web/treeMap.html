<!DOCTYPE HTML>
<html>
	<head>
		<title>Tree Map - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<!-- Add Leaflet CSS -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
			integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
			crossorigin=""/>
		<style>
			#map-container {
				height: 600px;
				width: 100%;
				margin-bottom: 2em;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			#map {
				height: 100%;
				width: 100%;
				z-index: 1;
			}
			#tree-info {
				background: white;
				padding: 2em;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				margin-bottom: 2em;
				display: none;
			}
			.tree-image {
				max-width: 300px;
				border-radius: 8px;
				margin-bottom: 1em;
			}
			.info-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1em;
				margin-top: 1em;
			}
			.info-item {
				background: #f8f9fa;
				padding: 1em;
				border-radius: 4px;
			}
			.info-item label {
				font-weight: bold;
				color: #2ecc71;
				margin-bottom: 0.5em;
				display: block;
			}
			.measurements-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
				gap: 0.5em;
				margin-top: 1em;
			}
			.measurement-item {
				background: #e8f5e9;
				padding: 0.5em;
				border-radius: 4px;
				text-align: center;
			}
			.measurement-item label {
				font-size: 0.8em;
				color: #2ecc71;
				margin-bottom: 0.2em;
			}
			.measurement-item p {
				margin: 0;
				font-weight: bold;
			}
			.custom-popup {
				padding: 10px;
			}
			.custom-popup img {
				max-width: 150px;
				border-radius: 4px;
				margin-bottom: 10px;
			}
			.custom-popup h4 {
				margin: 0 0 5px 0;
				color: #2ecc71;
			}
			.custom-popup p {
				margin: 0;
				color: #666;
				font-size: 0.9em;
			}
			/* Custom marker style */
			.custom-marker {
				background-color: #2ecc71;
				border: 2px solid #27ae60;
				border-radius: 50%;
				text-align: center;
				color: white;
				font-weight: bold;
			}
			.filter-container {
				background: white;
				padding: 2em;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				margin-bottom: 2em;
			}
			.filter-group {
				margin-bottom: 1em;
			}
			.filter-group label {
				display: block;
				color: #2ecc71;
				font-weight: bold;
				margin-bottom: 0.5em;
				font-size: 0.9em;
			}
			.filter-select, 
			.filter-input {
				width: 100%;
				padding: 0.8em;
				border-radius: 4px;
				border: 1px solid #ddd;
				background: #f8f9fa;
				font-size: 0.9em;
				transition: all 0.3s ease;
			}
			.filter-select:focus, 
			.filter-input:focus {
				outline: none;
				border-color: #2ecc71;
				box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.1);
			}
			.radius-container {
				display: flex;
				gap: 0.8em;
				align-items: stretch;
			}
			#radius-filter {
				flex: 1;
				min-width: 0;
			}
			#use-location {
				background: #34495e;
				color: white;
				border: none;
				border-radius: 4px;
				padding: 0.8em 1.2em;
				cursor: pointer;
				transition: background 0.3s ease;
				white-space: nowrap;
				display: flex;
				align-items: center;
				gap: 0.5em;
			}
			#use-location:hover {
				background: #2c3e50;
			}
			.filter-actions {
				display: flex;
				gap: 1em;
				margin-top: 1.5em;
				padding-top: 1.5em;
				border-top: 1px solid #eee;
			}
			.filter-actions button {
				flex: 1;
				padding: 0.8em 1.5em;
				border-radius: 4px;
				font-weight: 500;
				transition: all 0.3s ease;
			}
			#apply-filters {
				background: #2ecc71;
				color: white;
				border: none;
			}
			#apply-filters:hover {
				background: #27ae60;
			}
			#reset-filters {
				background: #f8f9fa;
				color: #666;
				border: 1px solid #ddd;
			}
			#reset-filters:hover {
				background: #e9ecef;
				border-color: #ccc;
			}
			.placeholder-style::placeholder {
				color: #aaa;
				font-style: italic;
			}
			.active-filter {
				background-color: #e8f5e9;
				border-color: #2ecc71;
			}
			/* Request modal styles */
			#request-modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
				z-index: 1000;
			}
			.request-modal-content {
				position: relative;
				background-color: white;
				margin: 10% auto;
				padding: 2em;
				width: 90%;
				max-width: 500px;
				border-radius: 8px;
				box-shadow: 0 2px 15px rgba(0,0,0,0.2);
			}
			.close-request-modal {
				position: absolute;
				right: 1em;
				top: 1em;
				font-size: 1.5em;
				cursor: pointer;
				color: #666;
				transition: color 0.3s ease;
			}
			.close-request-modal:hover {
				color: #333;
			}
			.request-form-group {
				margin-bottom: 1.5em;
			}
			.request-form-group label {
				display: block;
				color: #2ecc71;
				font-weight: bold;
				margin-bottom: 0.5em;
			}
			.request-form-group select,
			.request-form-group textarea {
				width: 100%;
				padding: 0.8em;
				border: 1px solid #ddd;
				border-radius: 4px;
				background: #f8f9fa;
				font-size: 0.9em;
			}
			.request-form-group textarea {
				min-height: 120px;
				resize: vertical;
			}
			.request-form-actions {
				display: flex;
				gap: 1em;
				margin-top: 2em;
			}
			.request-form-actions button {
				flex: 1;
				padding: 0.8em;
				border-radius: 4px;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.3s ease;
			}
			.submit-request {
				background: #2ecc71;
				color: white;
				border: none;
			}
			.submit-request:hover {
				background: #27ae60;
			}
			.cancel-request {
				background: #f8f9fa;
				color: #666;
				border: 1px solid #ddd;
			}
			.cancel-request:hover {
				background: #e9ecef;
			}
			/* Success popup styles */
			.success-popup {
				display: none;
				position: fixed;
				top: 20px;
				right: 20px;
				background: #2ecc71;
				color: white;
				padding: 1em 1.5em;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				z-index: 1000;
				animation: slideIn 0.5s ease-out;
			}
			.success-popup.show {
				display: flex;
				align-items: center;
				gap: 0.8em;
			}
			.success-popup i {
				font-size: 1.5em;
			}
			@keyframes slideIn {
				from {
					transform: translateX(100%);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}
			@keyframes fadeOut {
				from {
					transform: translateX(0);
					opacity: 1;
				}
				to {
					transform: translateX(100%);
					opacity: 0;
				}
			}
			.weather-grid {
				display: grid;
				grid-template-columns: 1fr 2fr;
				gap: 20px;
				align-items: center;
			}
			.weather-item {
				text-align: center;
			}
			.weather-icon {
				font-size: 3em;
				margin-bottom: 10px;
			}
			.weather-main {
				font-size: 1.2em;
				color: #2ecc71;
				margin-bottom: 5px;
			}
			.weather-temp {
				font-size: 2em;
				font-weight: bold;
			}
			.weather-details {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
				gap: 10px;
			}
			.weather-detail {
				background: #f8f9fa;
				padding: 10px;
				border-radius: 4px;
				text-align: center;
			}
			.weather-detail label {
				display: block;
				color: #2ecc71;
				font-size: 0.9em;
				margin-bottom: 5px;
			}
			.weather-detail span {
				font-weight: bold;
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" class="wrapper">
					<!-- Auth Buttons -->
					<div id="auth-container">
						<!-- Will be populated by JavaScript -->
					</div>

					<!-- Logo -->
						<div id="logo">
							<h1><a href="index.html">TreeMapper</a></h1>
							<p>Discover and track trees in your community</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li class="active"><a href="treeMap.html">Tree Map</a></li>
								<li><a href="pollution.html">Pollution Map</a></li>
								<li>
									<a href="treeDatabase.html">Tree Database</a>
									<ul>
										<li><a href="treeDatabase.html#tree-types">Tree Type Database</a></li>
										<li><a href="treeDatabase.html#tree-database">Tree Database</a></li>
										<li><a href="treeDatabase.html#upload-tree">Upload Tree</a></li>
									</ul>
								</li>
								<li><a href="community.html">Community</a></li>
								<li class="admin-only" style="display: none;"><a href="adminDashboard.html">Admin Dashboard</a></li>
							</ul>
						</nav>
				</section>

			<!-- Main -->
				<section id="main" class="wrapper style2">
					<div class="title">Tree Map</div>
					<div class="container">
						<!-- Add Filter Section -->
						<div id="filter-section" class="filter-container">
							<div class="row gtr-50">
								<div class="col-4 col-12-medium">
									<div class="filter-group">
										<label for="type-filter">Tree Type</label>
										<select id="type-filter" class="filter-select">
											<option value="">All Types</option>
											<!-- Will be populated by JavaScript -->
										</select>
									</div>
								</div>
								<div class="col-4 col-12-medium">
									<div class="filter-group">
										<label for="name-filter">Search by Name</label>
										<input type="text" id="name-filter" class="filter-input placeholder-style" 
											placeholder="Enter Greek or Scientific name...">
									</div>
								</div>
								<div class="col-4 col-12-medium">
									<div class="filter-group">
										<label for="radius-filter">Search by Radius (meters)</label>
										<div class="radius-container">
											<input type="number" id="radius-filter" class="filter-input placeholder-style" 
												placeholder="Enter radius..." min="0">
											<button id="use-location">
												<span>📍</span>
												<span>Location</span>
											</button>
										</div>
									</div>
								</div>
							</div>
							<div class="filter-actions">
								<button id="apply-filters">Apply Filters</button>
								<button id="reset-filters">Reset</button>
							</div>
						</div>

						<div id="map-container">
							<div id="map"></div>
						</div>

						<!-- Add Weather Information Section -->
						<div id="weather-info" class="chart-container" style="display: none;">
							<h3>Current Weather</h3>
							<div class="weather-grid">
								<div class="weather-item">
									<div class="weather-icon" id="weather-icon"></div>
									<div class="weather-main" id="weather-main"></div>
									<div class="weather-temp" id="weather-temp"></div>
								</div>
								<div class="weather-details">
									<div class="weather-detail">
										<label>Humidity</label>
										<span id="weather-humidity"></span>
									</div>
									<div class="weather-detail">
										<label>Wind Speed</label>
										<span id="weather-wind"></span>
									</div>
									<div class="weather-detail">
										<label>Pressure</label>
										<span id="weather-pressure"></span>
									</div>
								</div>
							</div>
						</div>

						<div id="tree-info">
							<h2>Tree Information</h2>
							<div id="tree-image-container"></div>
							<div class="info-grid">
								<div class="info-item">
									<label>Name</label>
									<p id="tree-name"></p>
								</div>
								<div class="info-item">
									<label>Type Code</label>
									<p id="tree-type"></p>
								</div>
								<div class="info-item">
									<label>Location</label>
									<p id="tree-location"></p>
								</div>
								<div class="info-item">
									<label>Added On</label>
									<p id="tree-date"></p>
								</div>
								<div class="info-item">
									<label>Inserted By</label>
									<p id="tree-inserted-by"></p>
								</div>
								<div class="info-item">
									<label>Coordinates</label>
									<p id="tree-coordinates"></p>
								</div>
								<div class="info-item">
									<label>Position</label>
									<p id="tree-position"></p>
								</div>
							</div>
							<div id="tree-measurements"></div>
							<div style="margin-top: 2em; text-align: right;">
								<button onclick="openRequestModal()" class="button style1">Submit Request</button>
							</div>
						</div>

						<!-- Request Modal -->
						<div id="request-modal">
							<div class="request-modal-content">
								<span class="close-request-modal" onclick="closeRequestModal()">&times;</span>
								<h3>Submit Request</h3>
								<form id="request-form" onsubmit="submitRequest(event)">
									<input type="hidden" id="request-tree-id">
									<div class="request-form-group">
										<label for="request-type">Request Type</label>
										<select id="request-type" required>
											<option value="TREE">Tree Related</option>
											<option value="PROFILE">Profile Related</option>
											<option value="OTHER">Other</option>
										</select>
									</div>
									<div class="request-form-group">
										<label for="request-description">Description</label>
										<textarea id="request-description" 
											placeholder="Please describe your request in detail..." 
											required></textarea>
									</div>
									<div class="request-form-actions">
										<button type="submit" class="submit-request">Submit Request</button>
										<button type="button" class="cancel-request" onclick="closeRequestModal()">Cancel</button>
									</div>
								</form>
							</div>
						</div>

						<!-- Success Popup -->
						<div id="success-popup" class="success-popup">
							<span>✅</span>
							<div>
								<strong>Success!</strong>
								<p style="margin: 0;">Your request has been submitted successfully.</p>
							</div>
						</div>
					</div>
				</section>

			<!-- Footer -->
				<section id="footer" class="wrapper">
					<div class="container">
						<div id="copyright">
							<ul>
								<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
							</ul>
						</div>
					</div>
				</section>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/auth.js"></script>
			<!-- Add Leaflet JS -->
			<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
				integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
				crossorigin=""></script>
			<script>
				let map;
				let markers = [];
				let currentPopup = null;
				let treeTypes = new Set();
				let allTrees = [];
				let userMarker = null;
				let radiusCircle = null;
				let currentTreeId = null;

				document.addEventListener('DOMContentLoaded', function() {
					checkAuth();
					checkActiveAuth();

					// Add event listeners for filters
					document.getElementById('apply-filters').addEventListener('click', applyFilters);
					document.getElementById('reset-filters').addEventListener('click', resetFilters);
					document.getElementById('use-location').addEventListener('click', useCurrentLocation);
					
					// Add input event listeners for real-time filtering
					document.getElementById('name-filter').addEventListener('input', debounce(applyFilters, 500));
					document.getElementById('type-filter').addEventListener('change', applyFilters);
				});

				function debounce(func, wait) {
					let timeout;
					return function executedFunction(...args) {
						const later = () => {
							clearTimeout(timeout);
							func(...args);
						};
						clearTimeout(timeout);
						timeout = setTimeout(later, wait);
					};
				}

				function checkActiveAuth() {
					const user = JSON.parse(localStorage.getItem('user'));
                    console.log(user);
					if (!user || user.status !== 'ACTIVE') {
						window.location.href = 'auth.html';
						return;
					}
					initMap();
				}

				function initMap() {
					// Initialize map with a default center
					map = L.map('map').setView([0, 0], 13);

					// Add OpenStreetMap tiles
					L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
						maxZoom: 19,
						attribution: '© OpenStreetMap contributors'
					}).addTo(map);

					// Try to get user's location
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(
							(position) => {
								const pos = {
									lat: position.coords.latitude,
									lng: position.coords.longitude,
								};
								map.setView([pos.lat, pos.lng], 13);
								loadTrees();
							},
							() => {
								// If geolocation fails, just load trees
								loadTrees();
							}
						);
					} else {
						loadTrees();
					}
				}

				function loadTrees() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_all_trees' })
					})
					.then(response => response.json())
					.then(data => {
						console.log(data);
						if (data.success) {
							allTrees = data.trees;
							if (allTrees.length > 0) {
								// Center map on first tree if no user location
								if (map.getCenter().lat === 0 && map.getCenter().lng === 0) {
									map.setView([
										parseFloat(allTrees[0].lat),
										parseFloat(allTrees[0].lon)
									], 13);
								}

								// Collect unique tree types
								allTrees.forEach(tree => {
									if (tree.type && tree.type.greek_name) {
										treeTypes.add(JSON.stringify({
											id: tree.type.id,
											name: `${tree.type.greek_name} (${tree.type.scientific_name})`
										}));
									}
								});

								// Populate type filter dropdown
								const typeFilter = document.getElementById('type-filter');
								[...treeTypes].sort().forEach(typeJson => {
									const type = JSON.parse(typeJson);
									const option = document.createElement('option');
									option.value = type.id;
									option.textContent = type.name;
									typeFilter.appendChild(option);
								});

								// Show all trees initially
								showFilteredTrees(allTrees);
							}
						} else {
							showMessage('error', data.message);
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to load trees');
					});
				}

				function showFilteredTrees(trees) {
					// Clear existing markers
					markers.forEach(marker => marker.remove());
					markers = [];

					// Add filtered trees to map
					trees.forEach(tree => addTreeToMap(tree));
				}

				function applyFilters() {
					const typeFilter = document.getElementById('type-filter').value;
					const nameFilter = document.getElementById('name-filter').value.toLowerCase();
					const radiusFilter = document.getElementById('radius-filter').value;

					let filteredTrees = allTrees;

					// Filter by type
					if (typeFilter) {
						filteredTrees = filteredTrees.filter(tree => 
							tree.type && tree.type.id === typeFilter
						);
					}

					// Filter by name
					if (nameFilter) {
						filteredTrees = filteredTrees.filter(tree => 
							(tree.type.greek_name && tree.type.greek_name.toLowerCase().includes(nameFilter)) ||
							(tree.type.scientific_name && tree.type.scientific_name.toLowerCase().includes(nameFilter))
						);
					}

					// Filter by radius if user location is available and radius is set
					if (radiusFilter && userMarker) {
						const userLatLng = userMarker.getLatLng();
						filteredTrees = filteredTrees.filter(tree => {
							const treeLatLng = L.latLng(parseFloat(tree.lat), parseFloat(tree.lon));
							const distanceInMeters = userLatLng.distanceTo(treeLatLng);
							return distanceInMeters <= parseFloat(radiusFilter);
						});

						// Update or create radius circle
						if (radiusCircle) {
							radiusCircle.setRadius(parseFloat(radiusFilter));
						} else {
							radiusCircle = L.circle(userLatLng, {
								radius: parseFloat(radiusFilter),
								color: '#2ecc71',
								fillColor: '#2ecc71',
								fillOpacity: 0.1
							}).addTo(map);
						}
					}

					showFilteredTrees(filteredTrees);
				}

				function resetFilters() {
					document.getElementById('type-filter').value = '';
					document.getElementById('name-filter').value = '';
					document.getElementById('radius-filter').value = '';

					// Remove user marker and radius circle
					if (userMarker) {
						userMarker.remove();
						userMarker = null;
					}
					if (radiusCircle) {
						radiusCircle.remove();
						radiusCircle = null;
					}

					showFilteredTrees(allTrees);
				}

				function useCurrentLocation() {
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(
							(position) => {
								const pos = {
									lat: position.coords.latitude,
									lng: position.coords.longitude,
								};

								// Remove existing user marker
								if (userMarker) {
									userMarker.remove();
								}

								// Add new user marker
								userMarker = L.marker([pos.lat, pos.lng], {
									icon: L.divIcon({
										className: 'custom-marker',
										html: '<span style="font-size: 12px;">📍</span>',
										iconSize: [20, 20],
										iconAnchor: [10, 10]
									})
								}).addTo(map);

								// Center map on user location
								map.setView([pos.lat, pos.lng], 15);

								// Apply filters if radius is set
								if (document.getElementById('radius-filter').value) {
									applyFilters();
								}
							},
							() => {
								showMessage('error', 'Unable to get your location');
							}
						);
					} else {
						showMessage('error', 'Geolocation is not supported by your browser');
					}
				}

				function addTreeToMap(tree) {
					const position = [parseFloat(tree.lat), parseFloat(tree.lon)];

					// Create custom marker icon
					const customIcon = L.divIcon({
						className: 'custom-marker',
						html: '<span style="font-size: 12px;">🌳</span>',
						iconSize: [20, 20],
						iconAnchor: [10, 10],
						popupAnchor: [0, -10]
					});

					const marker = L.marker(position, {
						icon: customIcon,
						title: tree.name
					}).addTo(map);

					// Create popup content
					const popupContent = `
						<div class="custom-popup">
							<h4>${tree.name}</h4>
							<p><em>${tree.type.scientific_name || 'Unknown species'}</em></p>
							${tree.url ? `<img src="${tree.url}" alt="${tree.name}">` : ''}
							<p>${tree.location.street_name} ${tree.location.street_number || ''}</p>
							<p>Added: ${new Date(tree.inserted_at).toLocaleDateString()}</p>
						</div>
					`;

					// Add popup to marker
					const popup = L.popup({
						maxWidth: 300,
						className: 'custom-popup'
					}).setContent(popupContent);

					marker.bindPopup(popup);

					// Click event
					marker.on('click', () => {
						showTreeDetails(tree);
					});

					markers.push(marker);
				}

				function showTreeDetails(tree) {
					currentTreeId = tree.id;
					document.getElementById('tree-info').style.display = 'block';
					
					// Show and update weather information
					document.getElementById('weather-info').style.display = 'block';
					fetchWeatherData(parseFloat(tree.lat), parseFloat(tree.lon));
					
					document.getElementById('tree-name').textContent = tree.name;
					document.getElementById('tree-type').innerHTML = `
						<div>
							<p><strong>Greek Name:</strong> ${tree.type.greek_name || 'N/A'}</p>
							<p><strong>Scientific Name:</strong> ${tree.type.scientific_name || 'N/A'}</p>
						</div>
					`;
					document.getElementById('tree-location').innerHTML = `
						<div>
							<p><strong>Street:</strong> ${tree.location.street_name} ${tree.location.street_number || ''}</p>
							<p><strong>Tax Code:</strong> ${tree.location.tax_code || 'N/A'}</p>
							<p><strong>Area ID:</strong> ${tree.location.area_id || 'N/A'}</p>
						</div>
					`;
					document.getElementById('tree-date').textContent = new Date(tree.inserted_at).toLocaleDateString();
					document.getElementById('tree-inserted-by').textContent = tree.inserted_by || 'N/A';
					document.getElementById('tree-coordinates').textContent = `${tree.lat}, ${tree.lon}`;
					document.getElementById('tree-position').textContent = `X: ${tree.absolute_position_x}, Y: ${tree.absolute_position_y}`;

					// Add measurements section
					const measurements = tree.type.measurements;
					const measurementsHtml = measurements.amount !== null ? `
						<div class="measurements-grid">
							<div class="measurement-item">
								<label>Amount</label>
								<p>${measurements.amount}</p>
							</div>
						</div>
					` : '<p>No measurements available</p>';
					
					document.getElementById('tree-measurements').innerHTML = measurementsHtml;

					const imageContainer = document.getElementById('tree-image-container');
					imageContainer.innerHTML = tree.url 
						? `<img src="${tree.url}" alt="${tree.name}" class="tree-image">` 
						: '<p>No image available</p>';

					// Scroll to tree info
					document.getElementById('tree-info').scrollIntoView({ behavior: 'smooth' });
				}

				async function fetchWeatherData(lat, lon) {
					try {
						// Replace 'YOUR_API_KEY' with your WeatherAPI.com API key
						const apiKey = 'ff7a4bb9584f49dda48122650252404';
						const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${lat},${lon}&aqi=no`);
						const data = await response.json();
						
						if (data.current) {
							updateWeatherDisplay(data);
						} else {
							console.error('Weather data fetch failed:', data.error?.message);
						}
					} catch (error) {
						console.error('Error fetching weather data:', error);
					}
				}

				function updateWeatherDisplay(data) {
					const current = data.current;
					
					// Update weather icon
					document.getElementById('weather-icon').innerHTML = 
						`<img src="${current.condition.icon}" alt="Weather icon">`;
					
					// Update main weather info
					document.getElementById('weather-main').textContent = current.condition.text;
					document.getElementById('weather-temp').textContent = 
						`${Math.round(current.temp_c)}°C`;
					
					// Update weather details
					document.getElementById('weather-humidity').textContent = 
						`${current.humidity}%`;
					document.getElementById('weather-wind').textContent = 
						`${Math.round(current.wind_kph)} km/h`;
					document.getElementById('weather-pressure').textContent = 
						`${current.pressure_mb} hPa`;
				}

				function formatMeasurementLabel(key) {
					const labels = {
						'amount': 'Amount'
					};
					return labels[key] || key;
				}

				function formatMeasurementValue(key, value) {
					return value !== null ? value : 'N/A';
				}

				function openRequestModal() {
					document.getElementById('request-modal').style.display = 'block';
					document.getElementById('request-tree-id').value = currentTreeId;
					document.getElementById('request-type').value = 'TREE';
					document.getElementById('request-description').value = '';
				}

				function closeRequestModal() {
					document.getElementById('request-modal').style.display = 'none';
				}

				function showSuccessPopup() {
					const popup = document.getElementById('success-popup');
					popup.classList.add('show');
					
					// Remove the popup after 3 seconds
					setTimeout(() => {
						popup.style.animation = 'fadeOut 0.5s ease-out';
						setTimeout(() => {
							popup.classList.remove('show');
							popup.style.animation = '';
						}, 500);
					}, 3000);
				}

				function submitRequest(event) {
					event.preventDefault();
					
					const requestData = {
						action: 'submit_request',
						target_id: currentTreeId,
						type: document.getElementById('request-type').value,
						description: document.getElementById('request-description').value
					};

					fetch('api/requests.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(requestData)
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							closeRequestModal();
							showSuccessPopup();
						} else {
							showMessage('error', data.message || 'Failed to submit request');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to submit request');
					});
				}

				// Close modal when clicking outside
				window.onclick = function(event) {
					const modal = document.getElementById('request-modal');
					if (event.target === modal) {
						closeRequestModal();
					}
				};
			</script>
	</body>
</html>
