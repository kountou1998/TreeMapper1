<!DOCTYPE HTML>
<html>
	<head>
		<title>Tree Database - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<style>
			.section-content {
				display: none;
			}
			.section-content.active {
				display: block;
			}
			.tree-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
				gap: 20px;
				margin-top: 20px;
			}
			.tree-card {
				background: #fff;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.tree-card h3 {
				margin-bottom: 10px;
				color: #2ecc71;
			}
			.tree-details {
				margin-top: 10px;
			}
			.tree-details p {
				margin: 5px 0;
			}
			.upload-form {
				max-width: 600px;
				margin: 0 auto;
				padding: 20px;
				background: #fff;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			.nav-tabs {
				display: flex;
				justify-content: center;
				margin-bottom: 2em;
				border-bottom: 2px solid #eee;
			}
			.nav-tabs button {
				background: none;
				border: none;
				padding: 1em 2em;
				margin: 0 0.5em;
				font-size: 1.1em;
				cursor: pointer;
				color: #484d55;
				border-bottom: 2px solid transparent;
				transition: all 0.3s ease;
			}
			.nav-tabs button.active {
				border-bottom: 2px solid #2ecc71;
				color: #2ecc71;
			}
			.message {
				padding: 1em;
				margin-bottom: 1em;
				border-radius: 4px;
				text-align: center;
				font-weight: bold;
			}
			.message.success {
				background-color: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.message.error {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.statistics-section {
				margin-bottom: 2em;
			}
			.stats-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1em;
				margin-bottom: 2em;
			}
			.stat-card {
				background: #f8f9fa;
				padding: 1.5em;
				border-radius: 8px;
				text-align: center;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: transform 0.2s;
			}
			.stat-card:hover {
				transform: translateY(-2px);
			}
			.stat-card h3 {
				color: #2ecc71;
				margin: 0 0 0.5em 0;
				font-size: 1.2em;
			}
			.stat-card p {
				font-size: 2em;
				margin: 0;
				color: #333;
				font-weight: bold;
			}
			.type-stats {
				background: #fff;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				margin-top: 1em;
			}
			.type-stats h3 {
				text-align: center;
				color: #2ecc71;
				margin-bottom: 1.5em;
			}
			.type-distribution-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
				gap: 15px;
			}
			.type-stat {
				background: #f8f9fa;
				padding: 15px;
				border-radius: 6px;
				border-left: 4px solid #2ecc71;
			}
			.type-stat-name {
				font-weight: bold;
				color: #2c3e50;
				margin-bottom: 5px;
			}
			.type-stat-count {
				color: #666;
				font-size: 0.9em;
			}
			.type-stat-percentage {
				float: right;
				background: #2ecc71;
				color: white;
				padding: 2px 8px;
				border-radius: 12px;
				font-size: 0.85em;
			}
			.search-section {
				background: #fff;
				padding: 1.5em;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				margin-bottom: 2em;
			}
			.search-field {
				position: relative;
				margin-bottom: 1em;
			}
			.search-field i {
				position: absolute;
				left: 12px;
				top: 50%;
				transform: translateY(-50%);
				color: #666;
				z-index: 1;
			}
			.search-field input,
			.search-field select {
				width: 100%;
				padding: 0.75em 1em 0.75em 2.5em;
				border: 1px solid #ddd;
				border-radius: 4px;
				background: #f8f9fa;
				color: #333;
				transition: all 0.3s ease;
			}
			.search-field input:focus,
			.search-field select:focus {
				border-color: #2ecc71;
				box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.2);
				outline: none;
			}
			.search-field input::placeholder {
				color: #999;
			}
			.button.fit {
				width: 100%;
				text-align: center;
				margin-bottom: 1em;
			}
			@media screen and (max-width: 980px) {
				.search-section .row > div {
					margin-bottom: 1em;
				}
			}
			.tree-number {
				position: absolute;
				top: 10px;
				right: 10px;
				background: #2ecc71;
				color: white;
				width: 30px;
				height: 30px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: bold;
			}
			.tree-card {
				position: relative;
			}
			.tree-type-card {
				background: white;
				padding: 1.5em;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				transition: all 0.3s ease;
			}
			.tree-type-card:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0,0,0,0.15);
			}
			.tree-type-card h3 {
				color: #2ecc71;
				margin: 0 0 0.5em 0;
			}
			.tree-type-card .scientific-name {
				color: #666;
				font-style: italic;
				margin-bottom: 1em;
			}
			.tree-type-card .amount {
				color: #333;
				font-weight: bold;
			}
			.admin-controls {
				margin-top: 1em;
				padding-top: 1em;
				border-top: 1px solid #eee;
				display: flex;
				flex-direction: column;
				gap: 0.5em;
				align-items: flex-end;
			}
			.admin-controls button {
				flex: none;
				width: 32px;
				height: 32px;
				padding: 0;
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 4px;
			}
			.admin-controls button i {
				font-size: 14px;
			}
			/* .admin-controls button.style3 {
				background-color: #e74c3c;
			}
			.admin-controls button.style3:hover {
				background-color: #c0392b;
			} */
			.admin-section {
				display: none; /* Hidden by default */
				margin-bottom: 1em;
			}
			.top-controls {
				border: none;
				margin: 0;
				padding: 0;
				justify-content: flex-end;
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" class="wrapper">
					<!-- Auth Buttons -->
					<div id="auth-container">
						<!-- Will be populated by JavaScript -->
					</div>

					<!-- Logo -->
						<div id="logo">
							<h1><a href="index.html">TreeMapper</a></h1>
							<p>Discover and track trees in your community</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li><a href="treeMap.html">Tree Map</a></li>
								<li><a href="pollution.html">Pollution Map</a></li>
								<li class="active">
									<a href="#">Tree Database</a>
									<ul>
										<li><a href="#" onclick="switchSection('tree-types')">Tree Type Database</a></li>
										<li><a href="#" onclick="switchSection('tree-database')">Tree Database</a></li>
										<li><a href="#" onclick="switchSection('upload-tree')">Upload Tree</a></li>
									</ul>
								</li>
								<li><a href="community.html">Community</a></li>
								<li class="admin-only"><a href="adminDashboard.html">Admin Dashboard</a></li>
							</ul>
						</nav>
				</section>

			<!-- Main -->
				<section id="main" class="wrapper style2">
					<div class="title">Tree Database</div>
					<div class="container">
						<!-- Navigation Tabs -->
						<div class="nav-tabs">
							<button onclick="switchSection('tree-types')" class="active">Tree Types</button>
							<button onclick="switchSection('tree-database')">Tree Database</button>
							<button onclick="switchSection('upload-tree')">Upload Tree</button>
						</div>

						<!-- Tree Types Section -->
						<div id="tree-types" class="section-content active">
							<h2>Tree Types Database</h2>
							
							<!-- Tree Types Statistics -->
							<div class="statistics-section">
								<div class="stats-grid">
									<div class="stat-card">
										<h3>Total Types</h3>
										<p id="total-tree-types">0</p>
									</div>
									<div class="stat-card">
										<h3>Total Amount</h3>
										<p id="total-amount">0</p>
									</div>
									<div class="stat-card">
										<h3>Average Amount</h3>
										<p id="average-amount">0</p>
									</div>
								</div>
							</div>

							<!-- Add Tree Type Button (Admin Only) -->
							<div class="admin-section">
								<div class="admin-controls top-controls">
									<button onclick="addTreeType()" class="button small style1">
										<i class="fas fa-plus"></i> ADD
									</button>
								</div>
							</div>

							<div class="tree-grid" id="tree-types-grid">
								<!-- Will be populated by JavaScript -->
							</div>
						</div>

						<!-- Tree Database Section -->
						<div id="tree-database" class="section-content">
							<h2>Tree Database</h2>
							
							<!-- Statistics Section -->
							<div class="statistics-section">
								<div class="stats-grid">
									<div class="stat-card">
										<h3>Total Trees</h3>
										<p id="total-trees">0</p>
									</div>
									<div class="stat-card">
										<h3>Total Types</h3>
										<p id="total-types">0</p>
									</div>
									<div class="stat-card">
										<h3>Latest Addition</h3>
										<p id="latest-tree">-</p>
									</div>
								</div>
								<div id="type-distribution" class="type-stats">
									<!-- Will be populated by JavaScript -->
								</div>
							</div>

							<!-- Search Section -->
							<div class="search-section">
								<div class="row gtr-50">
									<div class="col-4 col-12-medium">
										<div class="search-field">
											<i class="fas fa-search"></i>
											<input type="text" id="tree-search" placeholder="Search trees by name..." />
										</div>
									</div>
									<div class="col-4 col-12-medium">
										<div class="search-field">
											<i class="fas fa-tree"></i>
											<select id="type-filter">
												<option value="">All Tree Types</option>
												<!-- Will be populated by JavaScript -->
											</select>
										</div>
									</div>
									<div class="col-4 col-12-medium">
										<button onclick="resetSearch()" class="button style3 fit">
											<i class="fas fa-undo"></i> Reset Filters
										</button>
									</div>
								</div>
							</div>

							<div class="tree-grid" id="trees-grid">
								<!-- Will be populated by JavaScript -->
							</div>
						</div>

						<!-- Upload Tree Section -->
						<div id="upload-tree" class="section-content">
							<h2>Upload New Tree</h2>
							<form id="upload-tree-form" class="upload-form">
								<div class="row gtr-50">
									<div class="col-12">
										<label for="tree-name">Tree Name</label>
										<input type="text" id="tree-name" name="name" required />
									</div>
									<div class="col-12">
										<label for="tree-type">Tree Type</label>
										<select id="tree-type" name="type_code" required>
											<!-- Will be populated by JavaScript -->
										</select>
									</div>
									<div class="col-6">
										<label for="tree-lat">Latitude</label>
										<input type="number" id="tree-lat" name="lat" step="any" required />
									</div>
									<div class="col-6">
										<label for="tree-lon">Longitude</label>
										<input type="number" id="tree-lon" name="lon" step="any" required />
									</div>
									<div class="col-12">
										<label>Location</label>
										<div class="location-selection">
											<select id="existing-location" name="location_id">
												<option value="">Select existing location or add new</option>
												<!-- Will be populated by JavaScript -->
											</select>
										</div>
										<div id="new-location-fields" style="margin-top: 1em; display: none;">
											<input type="text" name="street_name" placeholder="Street Name" />
											<input type="text" name="street_number" placeholder="Street Number" />
											<input type="text" name="tax_code" placeholder="Tax Code" />
											<input type="text" name="area_id" placeholder="Area ID" />
										</div>
										<div style="margin-top: 0.5em;">
											<label>
												<input type="checkbox" id="add-new-location" /> Add New Location
											</label>
										</div>
									</div>
									<div class="col-12">
										<label for="tree-url">Image</label>
										<input type="file" id="tree-image" name="image" accept="image/*" />
										<small style="display: block; margin-top: 5px; color: #666;">
											Accepted formats: JPG, PNG, GIF (max 5MB)
										</small>
									</div>
									<div class="col-12">
										<ul class="actions">
											<li><input type="submit" class="button style1" value="Upload Tree" /></li>
											<li><input type="reset" class="button style2" value="Reset" /></li>
										</ul>
									</div>
								</div>
							</form>
						</div>
					</div>
				</section>

			<!-- Footer -->
				<section id="footer" class="wrapper">
					<div class="container">
						<div id="copyright">
							<ul>
								<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
							</ul>
						</div>
					</div>
				</section>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/auth.js"></script>
			<script>
				document.addEventListener('DOMContentLoaded', function() {
					checkAuth();
					loadTreeTypes();
					loadTrees();
					populateTreeTypeSelect();

					// Handle URL hash navigation
					function handleHashChange() {
						const hash = window.location.hash.substring(1) || 'tree-types';
						switchSection(hash);
					}

					// Listen for hash changes
					window.addEventListener('hashchange', handleHashChange);

					// Handle initial load
					handleHashChange();

					// Show admin section if user is admin
					const user = JSON.parse(localStorage.getItem('user'));
					if (user && user.role === 'admin') {
						document.querySelector('.admin-section').style.display = 'block';
					}
				});

				function switchSection(sectionId) {
					// Update active tab
					document.querySelectorAll('.nav-tabs button').forEach(button => {
						button.classList.remove('active');
						if (button.getAttribute('onclick').includes(sectionId)) {
							button.classList.add('active');
						}
					});

					// Update active section
					document.querySelectorAll('.section-content').forEach(section => {
						section.classList.remove('active');
					});
					document.getElementById(sectionId).classList.add('active');

					// Update URL hash without triggering hashchange event
					history.replaceState(null, '', `#${sectionId}`);
				}

				function loadTreeTypes() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_tree_types' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							const grid = document.getElementById('tree-types-grid');
							grid.innerHTML = '';

							// Calculate statistics
							const totalTypes = data.tree_types.length;
							const totalAmount = data.tree_types.reduce((sum, type) => {
								const amount = parseInt(type.amount) || 0;
								return sum + amount;
							}, 0);
							const averageAmount = totalTypes > 0 ? 
								Math.round(totalAmount / totalTypes * 100) / 100 : 0;

							// Format numbers for display
							document.getElementById('total-tree-types').textContent = totalTypes.toLocaleString();
							document.getElementById('total-amount').textContent = totalAmount.toLocaleString();
							document.getElementById('average-amount').textContent = averageAmount.toLocaleString(undefined, {
								minimumFractionDigits: 0,
								maximumFractionDigits: 2
							});

							// Display tree types
							data.tree_types.forEach(type => {
								const card = document.createElement('div');
								card.className = 'tree-type-card';
								
								// Check if user is admin
								const user = JSON.parse(localStorage.getItem('user'));
								const isAdmin = user && user.role === 'admin';
								
								card.innerHTML = `
									<h3>${type.greek_name}</h3>
									<p class="scientific-name">${type.scientific_name}</p>
									<p class="amount">Amount: ${parseInt(type.amount)?.toLocaleString() || 'N/A'}</p>
									${isAdmin ? `
										<div class="admin-controls">
											<button onclick="editTreeType(${type.id})" class="button small style1">
												<i class="fas fa-edit"></i>
											</button>
											<button onclick="deleteTreeType(${type.id})" class="button small style3">
												<i class="fas fa-trash"></i>
											</button>
										</div>
									` : ''}
								`;
								grid.appendChild(card);
							});

							// Add styles for admin controls
							const style = document.createElement('style');
							style.textContent = `
								.admin-controls {
									margin-top: 1em;
									padding-top: 1em;
									border-top: 1px solid #eee;
									display: flex;
									flex-direction: column;
									gap: 0.5em;
									align-items: flex-end;
								}
								.admin-controls button {
									flex: none;
									width: 32px;
									height: 32px;
									padding: 0;
									display: flex;
									align-items: center;
									justify-content: center;
									border-radius: 4px;
								}
								.admin-controls button i {
									font-size: 14px;
								}
								
							`;
							document.head.appendChild(style);
						} else {
							console.error('Failed to load tree types:', data.message);
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}

				let allTrees = []; // Store all trees for filtering

				function loadTrees() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_all_trees' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							allTrees = data.trees; // Store all trees
							updateStatistics(data.trees);
							displayTrees(data.trees);
						} else {
							showMessage('error', data.message);
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to load trees');
					});
				}

				function updateStatistics(trees) {
					// Update total trees
					document.getElementById('total-trees').textContent = trees.length;

					// Get unique types
					const types = [...new Set(trees.map(tree => tree.type.greek_name))];
					document.getElementById('total-types').textContent = types.length;

					// Get latest tree
					if (trees.length > 0) {
						const latest = trees.reduce((a, b) => 
							new Date(a.inserted_at) > new Date(b.inserted_at) ? a : b
						);
						document.getElementById('latest-tree').textContent = latest.name;
					}

					// Calculate type distribution
					const typeDistribution = trees.reduce((acc, tree) => {
						const typeName = tree.type.greek_name;
						acc[typeName] = (acc[typeName] || 0) + 1;
						return acc;
					}, {});

					// Display type distribution
					const distributionHtml = Object.entries(typeDistribution)
						.map(([type, count]) => `
							<div class="type-stat">
								<div class="type-stat-percentage">${Math.round(count/trees.length*100)}%</div>
								<div class="type-stat-name">${type}</div>
								<div class="type-stat-count">${count} trees</div>
							</div>
						`).join('');
					
					document.getElementById('type-distribution').innerHTML = `
						<h3>Type Distribution</h3>
						<div class="type-distribution-grid">
							${distributionHtml}
						</div>
					`;
				}

				function displayTrees(trees) {
					const grid = document.getElementById('trees-grid');
					grid.innerHTML = '';
					
					// Check if user is admin
					const user = JSON.parse(localStorage.getItem('user'));
					const isAdmin = user && user.role === 'admin';
					
					trees.forEach((tree, index) => {
						const card = document.createElement('div');
						card.className = 'tree-card';
						card.innerHTML = `
							<div class="tree-number">${index + 1}</div>
							<h3>${tree.name}</h3>
							<div class="tree-details">
								<p><strong>Type:</strong> ${tree.type.greek_name}</p>
								<p><strong>Scientific Name:</strong> ${tree.type.scientific_name}</p>
								<p><strong>Location:</strong> ${tree.location.street_name} ${tree.location.street_number}</p>
								<p><strong>Coordinates:</strong> ${tree.lat}, ${tree.lon}</p>
								<p><strong>Added By:</strong> ${tree.inserted_by}</p>
								<p><strong>Added On:</strong> ${new Date(tree.inserted_at).toLocaleDateString()}</p>
							</div>
							${isAdmin ? `
								<div class="admin-controls">
									<button onclick="editTree(${tree.id})" class="button small style1">
										<i class="fas fa-edit"></i>
									</button>
									<button onclick="deleteTree(${tree.id})" class="button small style3">
										<i class="fas fa-trash"></i>
									</button>
								</div>
							` : ''}
						`;
						grid.appendChild(card);
					});
				}

				function filterTrees() {
					const searchTerm = document.getElementById('tree-search').value.toLowerCase();
					const selectedType = document.getElementById('type-filter').value;

					const filteredTrees = allTrees.filter(tree => {
						const matchesSearch = 
							tree.name.toLowerCase().includes(searchTerm) ||
							tree.type.greek_name.toLowerCase().includes(searchTerm) ||
							tree.type.scientific_name.toLowerCase().includes(searchTerm);
						
						const matchesType = !selectedType || tree.type.greek_name === selectedType;

						return matchesSearch && matchesType;
					});

					displayTrees(filteredTrees);
				}

				function resetSearch() {
					document.getElementById('tree-search').value = '';
					document.getElementById('type-filter').value = '';
					displayTrees(allTrees);
				}

				// Add event listeners for search and filter
				document.addEventListener('DOMContentLoaded', function() {
					// ... existing DOMContentLoaded code ...

					document.getElementById('tree-search').addEventListener('input', filterTrees);
					document.getElementById('type-filter').addEventListener('change', filterTrees);
				});

				// Update the populateTreeTypeSelect function to also populate the filter
				function populateTreeTypeSelect() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_tree_types' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							// Populate upload form select
							const uploadSelect = document.getElementById('tree-type');
							uploadSelect.innerHTML = '<option value="">Select a tree type</option>';
							
							// Populate filter select
							const filterSelect = document.getElementById('type-filter');
							filterSelect.innerHTML = '<option value="">All Types</option>';
							
							data.tree_types.forEach(type => {
								const uploadOption = document.createElement('option');
								uploadOption.value = type.id;
								uploadOption.textContent = `${type.greek_name} (${type.scientific_name})`;
								uploadSelect.appendChild(uploadOption);

								const filterOption = document.createElement('option');
								filterOption.value = type.greek_name;
								filterOption.textContent = type.greek_name;
								filterSelect.appendChild(filterOption);
							});
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}

				document.getElementById('upload-tree-form').addEventListener('submit', function(e) {
					e.preventDefault();
					const formData = new FormData(this);
					formData.append('action', 'add_tree');

					fetch('api/trees.php', {
						method: 'POST',
						body: formData // Remove the headers to allow file upload
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							showMessage('success', 'Tree uploaded successfully');
							this.reset();
							loadTrees();
						} else {
							showMessage('error', data.message);
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to upload tree');
					});
				});

				function showMessage(type, message) {
					const messageDiv = document.createElement('div');
					messageDiv.className = `message ${type}`;
					messageDiv.textContent = message;
					
					const existingMessages = document.querySelectorAll('.message');
					existingMessages.forEach(msg => msg.remove());
					
					const container = document.querySelector('.container');
					container.insertBefore(messageDiv, container.firstChild);
					
					setTimeout(() => {
						messageDiv.remove();
					}, 3000);
				}

				document.getElementById('add-new-location').addEventListener('change', function() {
					const newLocationFields = document.getElementById('new-location-fields');
					const existingLocation = document.getElementById('existing-location');
					if (this.checked) {
						newLocationFields.style.display = 'block';
						existingLocation.disabled = true;
						existingLocation.value = '';
					} else {
						newLocationFields.style.display = 'none';
						existingLocation.disabled = false;
					}
				});

				function loadLocations() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ action: 'get_locations' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							const select = document.getElementById('existing-location');
							select.innerHTML = '<option value="">Select existing location or add new</option>';
							data.locations.forEach(location => {
								const option = document.createElement('option');
								option.value = location.id;
								option.textContent = `${location.street_name} ${location.street_number} (${location.tax_code})`;
								select.appendChild(option);
							});
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}

				document.addEventListener('DOMContentLoaded', function() {
					// Add loadLocations to existing DOMContentLoaded handlers
					loadLocations();
				});

				// Add new functions for tree type management
				function editTreeType(typeId) {
					// Get the tree type data from the button's parent card
					const button = event.currentTarget;
					const card = button.closest('.tree-type-card');
					const greekName = card.querySelector('h3').textContent;
					const scientificName = card.querySelector('.scientific-name').textContent;

					// Create modal for editing
					const modal = document.createElement('div');
					modal.className = 'modal';
					modal.innerHTML = `
						<div class="modal-content">
							<span class="close">&times;</span>
							<h3>Edit Tree Type</h3>
							<form id="edit-tree-type-form">
								<input type="hidden" name="id" value="${typeId}">
								<div class="row gtr-50">
									<div class="col-12">
										<label>Greek Name</label>
										<input type="text" name="greek_name" value="${greekName}" required>
									</div>
									<div class="col-12">
										<label>Scientific Name</label>
										<input type="text" name="scientific_name" value="${scientificName}" required>
									</div>
									<div class="col-12">
										<ul class="actions">
											<li><input type="submit" class="button style1" value="Save Changes"></li>
											<li><button type="button" class="button style2" onclick="closeModal()">Cancel</button></li>
										</ul>
									</div>
								</div>
							</form>
						</div>
					`;
					document.body.appendChild(modal);

					// Add modal styles if not already present
					if (!document.querySelector('#modal-styles')) {
						const modalStyles = document.createElement('style');
						modalStyles.id = 'modal-styles';
						modalStyles.textContent = `
							.modal {
								display: block;
								position: fixed;
								z-index: 1000;
								left: 0;
								top: 0;
								width: 100%;
								height: 100%;
								background-color: rgba(0,0,0,0.5);
								overflow-y: auto;
							}
							.modal-content {
								background-color: #fff;
								margin: 5% auto;
								padding: 2em;
								border-radius: 8px;
								width: 90%;
								max-width: 600px;
								position: relative;
							}
							.close {
								position: absolute;
								right: 1em;
								top: 1em;
								font-size: 1.5em;
								cursor: pointer;
							}
						`;
						document.head.appendChild(modalStyles);
					}

					// Handle form submission
					document.getElementById('edit-tree-type-form').addEventListener('submit', function(e) {
						e.preventDefault();
						const formData = new FormData(this);

						// Check for duplicates
						fetch('api/trees.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'check_duplicate_tree_type',
								id: typeId,
								greek_name: formData.get('greek_name'),
								scientific_name: formData.get('scientific_name')
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.duplicate) {
								showMessage('error', 'A tree type with these names already exists');
								return;
							}

							// If no duplicate, proceed with update
							fetch('api/trees.php', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({
									action: 'update_tree_type',
									id: typeId,
									greek_name: formData.get('greek_name'),
									scientific_name: formData.get('scientific_name')
								})
							})
							.then(response => response.json())
							.then(data => {
								if (data.success) {
									showMessage('success', 'Tree type updated successfully');
									closeModal();
									loadTreeTypes();
								} else {
									showMessage('error', data.message);
								}
							});
						});
					});
				}

				function deleteTreeType(typeId) {
					if (confirm('Are you sure you want to delete this tree type? This action cannot be undone.')) {
						fetch('api/trees.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'delete_tree_type',
								id: typeId
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								showMessage('success', 'Tree type deleted successfully');
								loadTreeTypes();
							} else {
								showMessage('error', data.message);
							}
						});
					}
				}

				function editTree(treeId) {
					// Get the tree data from the button's parent card
					const button = event.currentTarget;
					const card = button.closest('.tree-card');
					const name = card.querySelector('h3').textContent;
					const details = card.querySelector('.tree-details');
					const type = details.querySelector('p:nth-child(1)').textContent.replace('Type:', '').trim();
					
					// Extract coordinates from the correct paragraph
					const coordinatesText = details.querySelector('p:nth-child(4)').textContent;
					const coordinates = coordinatesText.split(':')[1].trim().split(',');
					const lat = coordinates[0].trim();
					const lon = coordinates[1].trim();

					// Create modal for editing
					const modal = document.createElement('div');
					modal.className = 'modal';
					modal.innerHTML = `
						<div class="modal-content">
							<span class="close">&times;</span>
							<h3>Edit Tree</h3>
							<form id="edit-tree-form">
								<input type="hidden" name="id" value="${treeId}">
								<div class="row gtr-50">
									<div class="col-12">
										<label>Name</label>
										<input type="text" name="name" value="${name}" required>
									</div>
									<div class="col-12">
										<label>Tree Type</label>
										<select name="type_code" required>
											<!-- Will be populated dynamically -->
										</select>
									</div>
									<div class="col-6">
										<label>Latitude</label>
										<input type="number" name="lat" value="${lat}" step="any" required>
									</div>
									<div class="col-6">
										<label>Longitude</label>
										<input type="number" name="lon" value="${lon}" step="any" required>
									</div>
									<div class="col-12">
										<ul class="actions">
											<li><input type="submit" class="button style1" value="Save Changes"></li>
											<li><button type="button" class="button style2" onclick="closeModal()">Cancel</button></li>
										</ul>
									</div>
								</div>
							</form>
						</div>
					`;
					document.body.appendChild(modal);

					// Populate tree types dropdown and select current type
					fetch('api/trees.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'get_tree_types' })
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							const select = document.querySelector('#edit-tree-form select[name="type_code"]');
							select.innerHTML = '<option value="">Select a tree type</option>';
							data.tree_types.forEach(treeType => {
								const option = document.createElement('option');
								option.value = treeType.id;
								option.textContent = `${treeType.greek_name} (${treeType.scientific_name})`;
								if (treeType.greek_name === type) {
									option.selected = true;
								}
								select.appendChild(option);
							});
						}
					});

					// Handle form submission
					document.getElementById('edit-tree-form').addEventListener('submit', function(e) {
						e.preventDefault();
						const formData = new FormData(this);
						fetch('api/trees.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'update_tree',
								id: treeId,
								name: formData.get('name'),
								type_code: formData.get('type_code'),
								lat: formData.get('lat'),
								lon: formData.get('lon')
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								showMessage('success', 'Tree updated successfully');
								closeModal();
								loadTrees();
							} else {
								showMessage('error', data.message);
							}
						});
					});
				}

				function deleteTree(treeId) {
					if (confirm('Are you sure you want to delete this tree? This action cannot be undone.')) {
						fetch('api/trees.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'delete_tree',
								id: treeId
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								showMessage('success', 'Tree deleted successfully');
								loadTrees();
							} else {
								showMessage('error', data.message);
							}
						});
					}
				}

				function closeModal() {
					const modal = document.querySelector('.modal');
					if (modal) {
						modal.remove();
					}
				}

				// Close modal when clicking outside
				window.onclick = function(event) {
					if (event.target.className === 'modal') {
						closeModal();
					}
				};

				function addTreeType() {
					const modal = document.createElement('div');
					modal.className = 'modal';
					modal.innerHTML = `
						<div class="modal-content">
							<span class="close">&times;</span>
							<h3>Add New Tree Type</h3>
							<form id="add-tree-type-form">
								<div class="row gtr-50">
									<div class="col-12">
										<label>Greek Name</label>
										<input type="text" name="greek_name" required>
									</div>
									<div class="col-12">
										<label>Scientific Name</label>
										<input type="text" name="scientific_name" required>
									</div>
									<div class="col-12">
										<ul class="actions">
											<li><input type="submit" class="button style1" value="Add Tree Type"></li>
											<li><button type="button" class="button style2" onclick="closeModal()">Cancel</button></li>
										</ul>
									</div>
								</div>
							</form>
						</div>
					`;
					document.body.appendChild(modal);

					// Handle form submission
					document.getElementById('add-tree-type-form').addEventListener('submit', function(e) {
						e.preventDefault();
						const formData = new FormData(this);

						// Check for duplicates first
						fetch('api/trees.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify({
								action: 'check_duplicate_tree_type',
								greek_name: formData.get('greek_name'),
								scientific_name: formData.get('scientific_name')
							})
						})
						.then(response => response.json())
						.then(data => {
							if (data.duplicate) {
								showMessage('error', 'A tree type with these names already exists');
								return;
							}

							// If no duplicate, proceed with adding
							fetch('api/trees.php', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({
									action: 'add_tree_type',
									greek_name: formData.get('greek_name'),
									scientific_name: formData.get('scientific_name')
								})
							})
							.then(response => response.json())
							.then(data => {
								if (data.success) {
									showMessage('success', 'Tree type added successfully');
									closeModal();
									loadTreeTypes();
								} else {
									showMessage('error', data.message);
								}
							});
						});
					});
				}
			</script>
	</body>
</html> 