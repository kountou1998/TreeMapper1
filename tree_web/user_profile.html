<!DOCTYPE HTML>
<html>
	<head>
		<title>User Profile - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<style>
			.profile-header {
				background-color: white;
				padding: 20px;
				border-radius: 10px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				margin-bottom: 20px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.profile-info h1 {
				margin: 0;
				color: #333;
			}

			.profile-stats {
				display: flex;
				gap: 20px;
				margin-top: 10px;
			}

			.stat {
				color: #666;
			}

			.report-btn {
				background-color: #e74c3c;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.report-btn:hover {
				background-color: #c0392b;
			}

			.tabs {
				display: flex;
				gap: 10px;
				margin-bottom: 20px;
			}

			.tab {
				padding: 10px 20px;
				background-color: white;
				border: none;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.tab.active {
				background-color: #2ecc71;
				color: white;
			}

			.timeline {
				display: grid;
				gap: 20px;
			}

			.timeline-item {
				background-color: white;
				padding: 20px;
				border-radius: 10px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				position: relative;
			}

			.timeline-content {
				position: relative;
			}

			.favorite-btn {
				position: absolute;
				top: -10px;
				right: -10px;
				background: none;
				border: none;
				padding: 0;
				width: 24px;
				height: 24px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: transform 0.2s;
				color: #f1c40f;
			}

			.favorite-btn:hover {
				transform: scale(1.2);
			}

			.tree-image {
				width: 100%;
				height: 200px;
				object-fit: cover;
				border-radius: 5px;
				margin-bottom: 10px;
			}

			.tree-info {
				margin-bottom: 10px;
			}

			.tree-info h3 {
				margin: 0 0 5px 0;
				color: #333;
			}

			.tree-meta {
				color: #666;
				font-size: 0.9em;
			}

			.view-map-btn {
				background-color: #2ecc71;
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 5px;
				cursor: pointer;
				transition: background-color 0.3s;
				width: 100%;
			}

			.view-map-btn:hover {
				background-color: #27ae60;
			}

			.modal {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
				justify-content: center;
				align-items: center;
				z-index: 1000;
			}

			.modal-content {
				background-color: white;
				padding: 20px;
				border-radius: 10px;
				width: 90%;
				max-width: 500px;
			}

			.modal h2 {
				margin-top: 0;
			}

			.modal textarea {
				width: 100%;
				height: 100px;
				margin: 10px 0;
				padding: 10px;
				border: 1px solid #ddd;
				border-radius: 5px;
				resize: vertical;
			}

			.modal-buttons {
				display: flex;
				gap: 10px;
				justify-content: flex-end;
			}

			.modal-btn {
				padding: 8px 16px;
				border: none;
				border-radius: 5px;
				cursor: pointer;
			}

			.cancel-btn {
				background-color: #95a5a6;
				color: white;
			}

			.submit-btn {
				background-color: #e74c3c;
				color: white;
			}

			.settings-section {
				display: none;
			}

			.settings-section.visible {
				display: block;
			}

			.settings-form {
				background-color: white;
				padding: 20px;
				border-radius: 10px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				margin-bottom: 20px;
			}

			.settings-form h3 {
				margin-top: 0;
			}

			@media (min-width: 768px) {
				.timeline {
					grid-template-columns: repeat(2, 1fr);
				}
			}

			@media (min-width: 1024px) {
				.timeline {
					grid-template-columns: repeat(3, 1fr);
				}
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" class="wrapper">
					<!-- Auth Buttons -->
					<div id="auth-container">
						<!-- Will be populated by JavaScript -->
					</div>

					<!-- Logo -->
						<div id="logo">
							<h1><a href="index.html">TreeMapper</a></h1>
							<p>Discover and track trees in your community</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li><a href="treeMap.html">Tree Map</a></li>
								<li><a href="pollution.html">Pollution Map</a></li>
								<li>
									<a href="treeDatabase.html">Tree Database</a>
									<ul>
										<li><a href="treeDatabase.html#tree-types">Tree Type Database</a></li>
										<li><a href="treeDatabase.html#tree-database">Tree Database</a></li>
										<li><a href="treeDatabase.html#upload-tree">Upload Tree</a></li>
									</ul>
								</li>
								<li><a href="community.html">Community</a></li>
								<li class="admin-only" style="display: none;"><a href="adminDashboard.html">Admin Dashboard</a></li>
							</ul>
						</nav>
				</section>

			<!-- Main -->
				<section id="main" class="wrapper style2">
					<div class="title" id="profile-title">Loading Profile...</div>
					<div class="container">
						<div class="profile-header">
							<div class="profile-info">
								<h1 id="username"></h1>
								<div class="profile-stats">
									<span class="stat">Member since: <span id="member-since"></span></span>
									<span class="stat">Uploads: <span id="uploads-count">0</span></span>
									<span class="stat">Favorites: <span id="favorites-count">0</span></span>
								</div>
							</div>
							<div class="profile-actions">
								<button class="report-btn" onclick="showReportModal()">
									<i class="fas fa-flag"></i> Report User
								</button>
							</div>
						</div>

						<div class="tabs">
							<button class="tab active" onclick="switchTab('uploads')">Uploads</button>
							<button class="tab" onclick="switchTab('favorites')">Favorites</button>
						</div>

						<div class="timeline" id="timeline"></div>
					</div>
				</section>

				<!-- Report Modal -->
				<div id="reportModal" class="modal">
					<div class="modal-content">
						<h2>Report User</h2>
						<p>Please provide a reason for reporting this user:</p>
						<textarea id="reportReason" placeholder="Enter your reason..."></textarea>
						<div class="modal-buttons">
							<button class="modal-btn cancel-btn" onclick="hideReportModal()">Cancel</button>
							<button class="modal-btn submit-btn" onclick="submitReport()">Submit Report</button>
						</div>
					</div>
				</div>

			<!-- Footer -->
				<section id="footer" class="wrapper">
					<div class="container">
						<div id="copyright">
							<ul>
								<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
							</ul>
						</div>
					</div>
				</section>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/auth.js"></script>
			<script>
				let currentUsername = null;
				let currentUserId = null;
				let currentTab = 'uploads';
				let favorites = new Set();

				document.addEventListener('DOMContentLoaded', () => {
					const urlParams = new URLSearchParams(window.location.search);
					currentUsername = urlParams.get('username');
					
					if (!currentUsername) {
						window.location.href = 'community.html';
						return;
					}

					loadUserProfile();
				});

				async function loadUserProfile() {
					try {
						const response = await fetch('api/user.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								action: 'get_user',
								username: currentUsername
							})
						});
						const data = await response.json();
						if (data.success) {
							const username = data.user.username;
							currentUserId = data.user.id;
							document.getElementById('username').textContent = username;
							document.getElementById('profile-title').textContent = username + "'s Profile";
							document.getElementById('member-since').textContent = new Date(data.user.created_at).toLocaleDateString();
							document.getElementById('uploads-count').textContent = data.user.uploads_count;
							document.getElementById('favorites-count').textContent = data.user.favorites_count;
							document.title = `${username}'s Profile - TreeMapper`;
                            
                            // loadFavorites();
                            loadUserTrees();
						} else {
							window.location.href = 'community.html';
						}
					} catch (error) {
						console.error('Error loading user profile:', error);
						window.location.href = 'community.html';
					}
				}

				// async function loadFavorites() {
				// 	try {
				// 		const response = await fetch('api/trees.php', {
				// 			method: 'POST',
				// 			headers: {
				// 				'Content-Type': 'application/json',
				// 			},
				// 			body: JSON.stringify({
				// 				action: 'get_favorites'
				// 			})
				// 		});
				// 		const data = await response.json();
				// 		if (data.success) {
				// 			favorites = new Set(data.favorites.map(tree => tree.id));
				// 			updateFavoriteButtons();
				// 		}
				// 	} catch (error) {
				// 		console.error('Error loading favorites:', error);
				// 	}
				// }

				async function loadUserTrees() {
                    console.log('Loading trees for user:', currentUsername);
                    console.log('Current User ID:', currentUserId);
                    console.log('Current Tab:', currentTab);
					if (!currentUserId) return; // Wait for user ID to be set
					try {
						const action = currentTab === 'uploads' ? 'get_user_trees' : 'get_user_favorites';
                        console.log('Action:', action);
                        const requestBody = currentTab === 'uploads' ?
                        {
                            action: action,
                            username: currentUsername
                        } : {
                            action: action,
                            user_id: currentUserId
                        };
                        console.log('Request body:', requestBody);
						const response = await fetch('api/trees.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify(requestBody)
						});
                        const data = await response.json();
                        console.log('Response:', data);
						if (data.success) {
							displayTrees(data.trees);
						}
					} catch (error) {
						console.error('Error loading trees:', error);
					}
				}

				function displayTrees(trees) {
					const timeline = document.getElementById('timeline');
					timeline.innerHTML = '';

					if (!trees || trees.length === 0) {
						timeline.innerHTML = `
							<div class="no-trees-message" style="text-align: center; padding: 2em;">
								<p>No ${currentTab} found.</p>
							</div>
						`;
						return;
					}

					trees.forEach(tree => {
						const timelineItem = document.createElement('div');
						timelineItem.className = 'timeline-item';
						timelineItem.innerHTML = `
							<div class="timeline-content">
								<button class="favorite-btn" onclick="toggleFavorite(${tree.id})">
									<i class="far fa-star"></i>
								</button>
								<img src="${tree.url}" alt="${tree.name}" class="tree-image">
								<div class="tree-info">
									<h3>${tree.name}</h3>
									<div class="tree-meta">
										<p>Type: ${tree.type.greek_name} (${tree.type.scientific_name})</p>
										<p>Location: ${tree.location.street_name} ${tree.location.street_number}</p>
										<p>Added on: ${new Date(tree.inserted_at).toLocaleDateString()}</p>
									</div>
								</div>
								<button class="view-map-btn" onclick="viewOnMap(${tree.lat}, ${tree.lon})">
									View on Map
								</button>
							</div>
						`;
						timeline.appendChild(timelineItem);
					});

					updateFavoriteButtons();
				}

				function updateFavoriteButtons() {
					document.querySelectorAll('.favorite-btn').forEach(btn => {
						const treeId = btn.getAttribute('onclick').match(/\d+/)[0];
						const icon = btn.querySelector('i');
						if (favorites.has(parseInt(treeId))) {
							icon.className = 'fas fa-star';
						} else {
							icon.className = 'far fa-star';
						}
					});
				}

				async function toggleFavorite(treeId) {
					try {
						const action = favorites.has(treeId) ? 'remove_favorite' : 'add_favorite';
						const response = await fetch('api/trees.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								action: action,
								tree_id: treeId
							})
						});
						const data = await response.json();
						if (data.success) {
							if (action === 'add_favorite') {
								favorites.add(treeId);
							} else {
								favorites.delete(treeId);
							}
							updateFavoriteButtons();
							if (currentTab === 'favorites') {
								loadUserTrees();
							}
						}
					} catch (error) {
						console.error('Error toggling favorite:', error);
					}
				}

				function switchTab(tab) {
					currentTab = tab;
					document.querySelectorAll('.tab').forEach(t => {
						t.classList.toggle('active', t.textContent.toLowerCase() === tab);
					});
					loadUserTrees();
				}

				function viewOnMap(lat, lon) {
					window.location.href = `map.html?lat=${lat}&lon=${lon}`;
				}

				function showReportModal() {
					document.getElementById('reportModal').style.display = 'flex';
				}

				function hideReportModal() {
					document.getElementById('reportModal').style.display = 'none';
					document.getElementById('reportReason').value = '';
				}

				async function submitReport() {
					const reason = document.getElementById('reportReason').value.trim();
					if (!reason) {
						alert('Please provide a reason for reporting.');
						return;
					}

					try {
						const response = await fetch('api/user.php', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({
								action: 'report_user',
								target_id: currentUserId,
								reason: reason
							})
						});
						const data = await response.json();
						if (data.success) {
							alert('Report submitted successfully.');
							hideReportModal();
						} else {
							alert(data.message || 'Failed to submit report. Please try again.');
						}
					} catch (error) {
						console.error('Error submitting report:', error);
						alert('Failed to submit report. Please try again.');
					}
				}

				function setupFormHandlers() {
					if (!isOwnProfile) return;

					// Handle username change
					document.getElementById('username-form').addEventListener('submit', async (e) => {
						e.preventDefault();
						const formData = new FormData(e.target);
						try {
							const response = await fetch('api/user.php', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									action: 'update_username',
									new_username: formData.get('new_username'),
									current_password: formData.get('current_password')
								})
							});
							const data = await response.json();
							alert(data.message);
							if (data.success) {
								loadUserProfile();
								e.target.reset();
							}
						} catch (error) {
							console.error('Error updating username:', error);
							alert('Failed to update username.');
						}
					});

					// Handle password change
					document.getElementById('password-form').addEventListener('submit', async (e) => {
						e.preventDefault();
						const formData = new FormData(e.target);
						if (formData.get('new_password') !== formData.get('confirm_password')) {
							alert('New passwords do not match.');
							return;
						}

						try {
							const response = await fetch('api/user.php', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									action: 'change_password',
									current_password: formData.get('current_password'),
									new_password: formData.get('new_password')
								})
							});
							const data = await response.json();
							alert(data.message);
							if (data.success) {
								e.target.reset();
							}
						} catch (error) {
							console.error('Error changing password:', error);
							alert('Failed to change password.');
						}
					});
				}

				function logout() {
					const formData = new FormData();
					formData.append('action', 'logout');

					fetch('api/auth.php', {
						method: 'POST',
						body: formData
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							localStorage.removeItem('user');
							window.location.href = 'index.html';
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}
			</script>
	</body>
</html>
