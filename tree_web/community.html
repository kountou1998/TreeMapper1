<!DOCTYPE HTML>
<html>
	<head>
		<title>Community - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<style>
			.timeline {
				position: relative;
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
			}

			.timeline::after {
				content: '';
				position: absolute;
				width: 6px;
				background-color: #2ecc71;
				top: 0;
				bottom: 0;
				left: 50%;
				margin-left: -3px;
				border-radius: 3px;
			}

			.timeline-item {
				padding: 10px 40px;
				position: relative;
				width: 50%;
				animation: fadeIn 0.5s ease-in-out;
			}

			@keyframes fadeIn {
				from { opacity: 0; transform: translateY(20px); }
				to { opacity: 1; transform: translateY(0); }
			}

			.timeline-item::after {
				content: '';
				position: absolute;
				width: 25px;
				height: 25px;
				right: -17px;
				background-color: white;
				border: 4px solid #2ecc71;
				top: 15px;
				border-radius: 50%;
				z-index: 1;
			}

			.left {
				left: 0;
			}

			.right {
				left: 50%;
			}

			.right::after {
				left: -8px;
			}

			.timeline-content {
				padding: 20px;
				background-color: white;
				position: relative;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}

			.timeline-content .favorite-btn {
				position: absolute;
				top: 5px;
				right: 20px;
				background: none;
				border: none;
				padding: 0;
				width: 24px;
				height: 24px;
				font-size: 1.2em;
				cursor: pointer;
				color: #f1c40f;
				transition: transform 0.2s ease;
				z-index: 2;
				display: flex;
				align-items: center;
				justify-content: right;
			}

			.timeline-content .favorite-btn:hover {
				transform: scale(1.2);
			}

			.timeline-content .favorite-btn.favorited {
				color: #f1c40f;
			}

			.timeline-content .favorite-btn.favorited:hover {
				color: #f39c12;
			}

			.timeline-content .actions {
				display: flex;
				gap: 10px;
				margin-top: 15px;
			}

			.timeline-content .actions button {
				padding: 8px 15px;
				border-radius: 4px;
				border: none;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.view-tree {
				background: #2ecc71;
				color: white;
				width: 100%;
			}

			.view-tree:hover {
				background: #27ae60;
			}

			.timeline-content h3 {
				color: #2ecc71;
				margin-bottom: 10px;
			}

			.timeline-content .meta {
				color: #666;
				font-size: 0.9em;
				margin-bottom: 15px;
			}

			.timeline-content .tree-image {
				width: 100%;
				max-height: 200px;
				object-fit: cover;
				border-radius: 4px;
				margin-bottom: 15px;
			}

			.timeline-content .tree-details {
				background: #f8f9fa;
				padding: 15px;
				border-radius: 4px;
				margin-bottom: 15px;
			}

			.timeline-content .tree-details p {
				margin: 5px 0;
			}

			@media screen and (max-width: 600px) {
				.timeline::after {
					left: 31px;
				}

				.timeline-item {
					width: 100%;
					padding-left: 70px;
					padding-right: 25px;
				}

				.timeline-item::after {
					left: 15px;
				}

				.right {
					left: 0%;
				}
			}

			.load-more {
				text-align: center;
				margin: 30px 0;
			}

			.load-more button {
				background: #34495e;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 4px;
				cursor: pointer;
				transition: background 0.3s ease;
			}

			.load-more button:hover {
				background: #2c3e50;
			}

			.no-trees {
				text-align: center;
				padding: 50px;
				color: #666;
			}

			.user-link {
				color: #2ecc71;
				text-decoration: none;
				transition: color 0.3s ease;
			}
			.user-link:hover {
				color: #27ae60;
				text-decoration: underline;
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header" class="wrapper">
					<!-- Auth Buttons -->
					<div id="auth-container">
						<!-- Will be populated by JavaScript -->
					</div>

					<!-- Logo -->
						<div id="logo">
							<h1><a href="index.html">TreeMapper</a></h1>
							<p>Discover and track trees in your community</p>
						</div>

					<!-- Nav -->
						<nav id="nav">
							<ul>
								<li><a href="index.html">Home</a></li>
								<li><a href="treeMap.html">Tree Map</a></li>
								<li><a href="pollution.html">Pollution Map</a></li>
								<li>
									<a href="treeDatabase.html">Tree Database</a>
									<ul>
										<li><a href="treeDatabase.html#tree-types">Tree Type Database</a></li>
										<li><a href="treeDatabase.html#tree-database">Tree Database</a></li>
										<li><a href="treeDatabase.html#upload-tree">Upload Tree</a></li>
									</ul>
								</li>
								<li class="active"><a href="community.html">Community</a></li>
								<li class="admin-only" style="display: none;"><a href="adminDashboard.html">Admin Dashboard</a></li>
							</ul>
						</nav>
				</section>

			<!-- Main -->
				<section id="main" class="wrapper style2">
					<div class="title">Community Timeline</div>
					<div class="container">
						<div class="timeline">
							<!-- Timeline items will be populated by JavaScript -->
						</div>
						<div class="load-more">
							<button onclick="loadMoreTrees()">Load More</button>
						</div>
					</div>
				</section>

			<!-- Footer -->
				<section id="footer" class="wrapper">
					<div class="container">
						<div id="copyright">
							<ul>
								<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
							</ul>
						</div>
					</div>
				</section>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script src="assets/js/auth.js"></script>
			<script>
				let page = 1;
				const itemsPerPage = 10;
				let hasMoreTrees = true;
				let favorites = new Set(); // Store favorite tree IDs

				document.addEventListener('DOMContentLoaded', function() {
					checkAuth();
					loadFavorites();
					loadTrees();
				});

				function loadFavorites() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: 'get_favorites'
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							favorites = new Set(data.favorites.map(tree => tree.id));
							// Update UI if trees are already displayed
							updateFavoriteButtons();
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}

				function updateFavoriteButtons() {
					document.querySelectorAll('.favorite-btn').forEach(button => {
						const treeId = button.getAttribute('data-tree-id');
						if (favorites.has(parseInt(treeId))) {
							button.classList.add('favorited');
							button.innerHTML = '<i class="fas fa-star"></i>';
						} else {
							button.classList.remove('favorited');
							button.innerHTML = '<i class="far fa-star"></i>';
						}
					});
				}

				function toggleFavorite(treeId) {
					const isFavorited = favorites.has(treeId);
					const action = isFavorited ? 'remove_favorite' : 'add_favorite';

					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: action,
							tree_id: treeId
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							if (isFavorited) {
								favorites.delete(treeId);
							} else {
								favorites.add(treeId);
							}
							updateFavoriteButtons();
						} else {
							showMessage('error', data.message || 'Failed to update favorite');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to update favorite');
					});
				}

				function loadTrees() {
					fetch('api/trees.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: 'get_all_trees',
							page: page,
							limit: itemsPerPage
						})
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							if (data.trees.length === 0) {
								hasMoreTrees = false;
								if (page === 1) {
									document.querySelector('.timeline').innerHTML = `
										<div class="no-trees">
											<h3>No trees uploaded yet</h3>
											<p>Be the first to contribute to our community!</p>
										</div>
									`;
								}
								document.querySelector('.load-more').style.display = 'none';
								return;
							}

							displayTrees(data.trees);
						} else {
							showMessage('error', data.message || 'Failed to load trees');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showMessage('error', 'Failed to load trees');
					});
				}

				function displayTrees(trees) {
					const timeline = document.querySelector('.timeline');
					timeline.innerHTML = ''; // Clear existing content
					
					let displayIndex = 0; // Keep track of displayed items for alternating sides
					
					trees.forEach((tree) => {
						// Skip trees inserted by admin
						if (tree.inserted_by === 'default') {
							return;
						}

						const isLeft = (page % 2 === 1) ? (displayIndex % 2 === 0) : (displayIndex % 2 !== 0);
						const timelineItem = document.createElement('div');
						timelineItem.className = `timeline-item ${isLeft ? 'left' : 'right'}`;
						
						timelineItem.innerHTML = `
							<div class="timeline-content">
								<button class="favorite-btn" data-tree-id="${tree.id}" onclick="toggleFavorite(${tree.id})">
									<i class="far fa-star"></i>
								</button>
								<h3>${tree.name}</h3>
								<div class="meta">
									<span>Added by <a href="user_profile.html?username=${tree.inserted_by}" class="user-link">${tree.inserted_by}</a></span>
									<span> • </span>
									<span>${new Date(tree.inserted_at).toLocaleDateString()}</span>
								</div>
								${tree.url ? `<img src="${tree.url}" alt="${tree.name}" class="tree-image">` : ''}
								<div class="tree-details">
									<p><strong>Type:</strong> ${tree.type.greek_name} (${tree.type.scientific_name})</p>
									<p><strong>Location:</strong> ${tree.location.street_name} ${tree.location.street_number || ''}</p>
									<p><strong>Coordinates:</strong> ${tree.lat}, ${tree.lon}</p>
								</div>
								<div class="actions">
									<button class="view-tree" onclick="viewTreeOnMap(${tree.lat}, ${tree.lon})">
										<i class="fas fa-map-marker-alt"></i> View on Map
									</button>
								</div>
							</div>
						`;
						
						timeline.appendChild(timelineItem);
						displayIndex++; // Increment only for displayed items
					});

					// Show message if no community uploads
					if (displayIndex === 0) {
						timeline.innerHTML = `
							<div class="no-trees-message" style="text-align: center; padding: 2em;">
								<p>No community uploads found. Be the first to contribute!</p>
							</div>
						`;
					}

					// Update favorite buttons state
					updateFavoriteButtons();
				}

				function loadMoreTrees() {
					if (!hasMoreTrees) return;
					
					page++;
					loadTrees();
				}

				function viewTreeOnMap(lat, lon) {
					// Store coordinates in localStorage to center the map on this tree
					localStorage.setItem('viewTree', JSON.stringify({ lat, lon }));
					window.location.href = 'treeMap.html';
				}
			</script>
	</body>
</html>
