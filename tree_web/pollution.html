<!DOCTYPE HTML>
<html>
	<head>
		<title>Pollution Data - TreeMapper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
			#map-container {
				height: 600px;
				width: 100%;
				margin-bottom: 2em;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			#map {
				height: 100%;
				width: 100%;
				z-index: 1;
			}
			.chart-container {
				background: white;
				padding: 2em;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				margin-bottom: 2em;
			}
			.chart-container h3 {
				margin-top: 0;
				color: #2ecc71;
				font-size: 1.2em;
				margin-bottom: 15px;
			}
			.filters {
				background: white;
				padding: 2em;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				margin-bottom: 2em;
			}
			.filter-group {
				margin-bottom: 1em;
			}
			.filter-group label {
				display: block;
				color: #2ecc71;
				font-weight: bold;
				margin-bottom: 0.5em;
				font-size: 0.9em;
			}
			.filter-group select {
				width: 100%;
				padding: 0.8em;
				border-radius: 4px;
				border: 1px solid #ddd;
				background: #f8f9fa;
				font-size: 0.9em;
				transition: all 0.3s ease;
			}
			.filter-group select:focus {
				outline: none;
				border-color: #2ecc71;
				box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.1);
			}
			#updateData {
				background: #2ecc71;
				color: white;
				border: none;
				padding: 0.8em 1.5em;
				border-radius: 4px;
				cursor: pointer;
				transition: background 0.3s ease;
			}
			#updateData:hover {
				background: #27ae60;
			}
			.grid-container {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
				gap: 20px;
				margin-bottom: 20px;
			}
			@media (max-width: 768px) {
				.grid-container {
					grid-template-columns: 1fr;
				}
			}
		</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">
			<!-- Header -->
			<section id="header" class="wrapper">
				<!-- Auth Buttons -->
				<div id="auth-container">
					<!-- Will be populated by JavaScript -->
				</div>

				<!-- Logo -->
				<div id="logo">
					<h1><a href="index.html">TreeMapper</a></h1>
					<p>Discover and track trees in your community</p>
				</div>

				<!-- Nav -->
				<nav id="nav">
					<ul>
						<li><a href="index.html">Home</a></li>
						<li><a href="treeMap.html">Tree Map</a></li>
						<li class="active"><a href="pollution.html">Pollution Data</a></li>
						<li>
							<a href="treeDatabase.html">Tree Database</a>
							<ul>
								<li><a href="treeDatabase.html#tree-types">Tree Type Database</a></li>
								<li><a href="treeDatabase.html#tree-database">Tree Database</a></li>
								<li><a href="treeDatabase.html#upload-tree">Upload Tree</a></li>
							</ul>
						</li>
						<li><a href="community.html">Community</a></li>
						<li class="admin-only" style="display: none;"><a href="adminDashboard.html">Admin Dashboard</a></li>
					</ul>
				</nav>
			</section>

			<!-- Main -->
			<section id="main" class="wrapper style2">
				<div class="title">Pollution Data Analysis</div>
				<div class="container">
					<div class="filters">
						<div class="row gtr-50">
							<div class="col-6 col-12-medium">
								<div class="filter-group">
									<label for="timeRange">Time Range</label>
									<select id="timeRange">
										<option value="7">Last 7 Days</option>
										<option value="30">Last 30 Days</option>
										<option value="90">Last 90 Days</option>
										<option value="365">Last Year</option>
										<option value="1095">Last 3 Years</option>
										<option value="0">All Time</option>
									</select>
								</div>
							</div>
							<div class="col-6 col-12-medium">
								<div class="filter-group">
									<label for="pollutantType">Pollutant Type</label>
									<select id="pollutantType">
										<option value="all">All Pollutants</option>
										<option value="pm25">PM2.5</option>
										<option value="pm10">PM10</option>
										<option value="no2">NO2</option>
										<option value="o3">O3</option>
									</select>
								</div>
							</div>
						</div>
						<div style="text-align: right; margin-top: 1em;">
							<button id="updateData">Update Data</button>
						</div>
					</div>

					<div id="map-container">
						<div id="map"></div>
					</div>

					<div class="grid-container">
						<div class="chart-container">
							<h3>Pollution Timeline</h3>
							<canvas id="timelineChart"></canvas>
						</div>
						<div class="chart-container">
							<h3>Area Comparison</h3>
							<canvas id="areaChart"></canvas>
						</div>
						<div class="chart-container">
							<h3>Pollutant Distribution</h3>
							<canvas id="distributionChart"></canvas>
						</div>
						<div class="chart-container">
							<h3>Pollution Trend</h3>
							<canvas id="trendChart"></canvas>
						</div>
						<div class="chart-container">
							<h3>Additional Metrics</h3>
							<canvas id="additionalMetricsChart"></canvas>
						</div>
					</div>
				</div>
			</section>

			<!-- Footer -->
			<section id="footer" class="wrapper">
				<div class="container">
					<div id="copyright">
						<ul>
							<li>&copy; TreeMapper. All rights reserved.</li><li>Design: <a href="#">Efstratios Kountouras</a></li>
						</ul>
					</div>
				</div>
			</section>
		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.dropotron.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="assets/js/auth.js"></script>
		<script>
			let map;
			let timelineChart;
			let areaChart;
			let distributionChart;
			let trendChart;
			let additionalMetricsChart;
			let markers = [];

			// Initialize map
			function initMap() {
				map = L.map('map').setView([0, 0], 2);
				L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '© OpenStreetMap contributors'
				}).addTo(map);
			}

			// Initialize charts
			function initCharts() {
				timelineChart = new Chart(document.getElementById('timelineChart'), {
					type: 'line',
					options: {
						responsive: true,
						scales: {
							y: {
								beginAtZero: true
							}
						}
					}
				});

				areaChart = new Chart(document.getElementById('areaChart'), {
					type: 'bar',
					options: {
						responsive: true,
						scales: {
							y: {
								beginAtZero: true
							}
						}
					}
				});

				distributionChart = new Chart(document.getElementById('distributionChart'), {
					type: 'pie',
					options: {
						responsive: true
					}
				});

				trendChart = new Chart(document.getElementById('trendChart'), {
					type: 'line',
					options: {
						responsive: true,
						scales: {
							y: {
								beginAtZero: true
							}
						}
					}
				});

				additionalMetricsChart = new Chart(document.getElementById('additionalMetricsChart'), {
					type: 'line',
					options: {
						responsive: true,
						interaction: {
							mode: 'index',
							intersect: false,
						},
						scales: {
							y: {
								type: 'linear',
								display: true,
								position: 'left',
								title: {
									display: true,
									text: 'Temperature (°C)'
								}
							},
							y1: {
								type: 'linear',
								display: true,
								position: 'right',
								title: {
									display: true,
									text: 'Humidity (%)'
								},
								grid: {
									drawOnChartArea: false
								}
							},
							y2: {
								type: 'linear',
								display: true,
								position: 'right',
								title: {
									display: true,
									text: 'CO/NO (ppm)'
								},
								grid: {
									drawOnChartArea: false
								}
							}
						}
					}
				});
			}

			// Update map markers
			function updateMapMarkers(data) {
				// Clear existing markers
				markers.forEach(marker => map.removeLayer(marker));
				markers = [];

				// Add new markers
				data.forEach(point => {
					const marker = L.circleMarker([point.lat, point.lon], {
						radius: 10,
						fillColor: getColorForValue(point.value),
						color: '#000',
						weight: 1,
						opacity: 1,
						fillOpacity: 0.8
					}).addTo(map);

					// Create popup content with pollutant type
					const popupContent = `
						<strong>${point.location}</strong><br>
						${point.pollutant ? `Pollutant: ${point.pollutant}<br>` : ''}
						Value: ${point.value}<br>
						Time: ${new Date(point.timestamp).toLocaleString()}
					`;

					marker.bindPopup(popupContent);
					markers.push(marker);
				});

				// Fit map bounds to show all markers
				if (markers.length > 0) {
					const group = L.featureGroup(markers);
					map.fitBounds(group.getBounds());
				}
			}

			// Get color based on pollution value
			function getColorForValue(value) {
				if (value < 50) return '#2ecc71';
				if (value < 100) return '#f1c40f';
				if (value < 150) return '#e67e22';
				return '#e74c3c';
			}

			// Update charts
			function updateCharts(data) {
				// Update timeline chart
				timelineChart.data = data.timeline_data;
				timelineChart.update();

				// Update area chart
				areaChart.data = data.area_data;
				areaChart.update();

				// Update distribution chart
				distributionChart.data = data.distribution_data;
				distributionChart.update();

				// Update trend chart
				trendChart.data = data.trend_data;
				trendChart.update();

				// Update additional metrics chart
				additionalMetricsChart.data = data.additional_metrics_data;
				additionalMetricsChart.update();
			}

			// Fetch pollution data
			async function fetchPollutionData() {
				const timeRange = document.getElementById('timeRange').value;
				const pollutantType = document.getElementById('pollutantType').value;

				try {
					const response = await fetch('api/pollution.php', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							action: 'get_pollution_data',
							time_range: timeRange,
							pollutant_type: pollutantType
						})
					});

					const data = await response.json();
					if (data.success) {
						updateMapMarkers(data.map_data);
						updateCharts(data);
					} else {
						showMessage('error', data.message);
					}
				} catch (error) {
					console.error('Error fetching pollution data:', error);
					showMessage('error', 'Failed to fetch pollution data');
				}
			}

			// Initialize page
			document.addEventListener('DOMContentLoaded', () => {
				checkAuth();
				initMap();
				initCharts();
				fetchPollutionData();

				// Add event listener for update button
				document.getElementById('updateData').addEventListener('click', fetchPollutionData);
			});
		</script>
	</body>
</html> 